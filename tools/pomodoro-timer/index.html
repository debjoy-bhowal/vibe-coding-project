<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pomodoro Timer - Vibe Coding</title>
    <meta name="description" content="Productivity-focused Pomodoro timer with customizable intervals, statistics, and notifications">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- DaisyUI -->
    <link href="https://cdn.jsdelivr.net/npm/daisyui@3.9.4/dist/full.css" rel="stylesheet" type="text/css" />
    
    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Chart.js for statistics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#8B5CF6',
                        secondary: '#06B6D4',
                        accent: '#F59E0B',
                        success: '#10B981',
                        warning: '#F59E0B',
                        error: '#EF4444',
                    },
                    screens: {
                        'xs': '375px',
                    }
                }
            }
        }
    </script>
    
    <style>
        /* Custom animations */
        @keyframes pulse-ring {
            0% {
                transform: scale(0.33);
            }
            40%, 50% {
                opacity: 1;
            }
            100% {
                opacity: 0;
                transform: scale(1);
            }
        }
        
        .pulse-ring {
            animation: pulse-ring 1.25s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
        }
        
        @keyframes bounce-subtle {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-10px);
            }
            60% {
                transform: translateY(-5px);
            }
        }
        
        .bounce-subtle {
            animation: bounce-subtle 2s infinite;
        }
        
        /* Circular progress bar */
        .circular-progress {
            transform: rotate(-90deg);
        }
        
        .progress-ring {
            transition: stroke-dashoffset 0.35s;
        }
        
        /* Notification styles */
        .notification-popup {
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        /* Toast notification */
        .toast-notification {
            z-index: 1000;
        }
        
        /* Dark theme styles */
        html.dark {
            color-scheme: dark;
        }
        
        html.dark .bg-white\/80 {
            background-color: rgba(31, 41, 55, 0.8) !important;
        }
        
        html.dark .bg-white {
            background-color: rgb(31, 41, 55) !important;
        }
        
        html.dark .bg-gray-50 {
            background-color: rgb(55, 65, 81) !important;
        }
        
        html.dark .text-gray-800 {
            color: rgb(229, 231, 235) !important;
        }
        
        html.dark .text-gray-600 {
            color: rgb(156, 163, 175) !important;
        }
        
        html.dark .text-gray-500 {
            color: rgb(107, 114, 128) !important;
        }
        
        html.dark .border-gray-200 {
            border-color: rgb(55, 65, 81) !important;
        }
        
        html.dark .shadow-lg {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.1) !important;
        }
        
        /* Smooth theme transitions */
        * {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-purple-50 via-blue-50 to-indigo-100" x-data="pomodoroApp()">
    
    <!-- Header -->
    <header class="bg-white/80 backdrop-blur-md shadow-lg">
        <div class="container mx-auto px-4 py-3">
            <div class="flex items-center gap-2 md:gap-4">
                <a href="../../index.html" class="btn btn-ghost btn-sm gap-1 md:gap-2">
                    <i class="fas fa-arrow-left"></i>
                    <span class="hidden md:inline">Back to Hub</span>
                </a>
                <div class="divider divider-horizontal hidden md:flex"></div>
                <h1 class="text-lg md:text-2xl font-bold text-gray-800 flex items-center gap-1 md:gap-2">
                    <i class="fas fa-clock text-primary text-sm md:text-base"></i>
                    Pomodoro Timer
                </h1>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        
        <!-- Timer Display -->
        <div class="text-center mb-8">
            <div class="relative inline-block">
                <!-- Circular Progress Ring -->
                <svg class="w-80 h-80 circular-progress" viewBox="0 0 120 120">
                    <!-- Background circle -->
                    <circle cx="60" cy="60" r="54" fill="none" stroke="#e5e7eb" stroke-width="6"/>
                    <!-- Progress circle -->
                    <circle 
                        cx="60" 
                        cy="60" 
                        r="54" 
                        fill="none" 
                        :stroke="currentSession.type === 'work' ? '#8B5CF6' : '#10B981'" 
                        stroke-width="6"
                        stroke-linecap="round"
                        class="progress-ring"
                        :stroke-dasharray="339.292"
                        :stroke-dashoffset="339.292 - (339.292 * progress / 100)"
                    />
                    
                    <!-- Pulse rings when active -->
                    <template x-if="isRunning">
                        <circle 
                            cx="60" 
                            cy="60" 
                            r="54" 
                            fill="none" 
                            :stroke="currentSession.type === 'work' ? '#8B5CF6' : '#10B981'" 
                            stroke-width="2"
                            opacity="0.3"
                            class="pulse-ring"
                        />
                    </template>
                </svg>
                
                <!-- Timer Text Overlay -->
                <div class="absolute inset-0 flex flex-col items-center justify-center">
                    <div class="text-6xl font-bold text-gray-800 mb-2" x-text="formatTime(timeLeft)"></div>
                    <div class="text-xl font-medium" :class="currentSession.type === 'work' ? 'text-purple-600' : 'text-green-600'">
                        <i :class="currentSession.type === 'work' ? 'fas fa-briefcase' : 'fas fa-coffee'"></i>
                        <span x-text="currentSession.label" class="ml-2"></span>
                    </div>
                    <div class="text-sm text-gray-500 mt-2">
                        Session <span x-text="currentSessionNumber"></span> of <span x-text="totalSessions"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Control Buttons -->
        <div class="flex justify-center gap-4 mb-8">
            <button 
                @click="toggleTimer()" 
                class="btn btn-lg"
                :class="isRunning ? 'btn-error' : 'btn-primary'"
            >
                <i :class="isRunning ? 'fas fa-pause' : 'fas fa-play'"></i>
                <span x-text="isRunning ? 'Pause' : 'Start'"></span>
            </button>
            
            <button 
                @click="resetTimer()" 
                class="btn btn-lg btn-outline"
                :disabled="!isRunning && timeLeft === currentSession.duration * 60"
            >
                <i class="fas fa-redo"></i>
                Reset
            </button>
            
            <button 
                @click="skipSession()" 
                class="btn btn-lg btn-ghost"
                :disabled="!isRunning && timeLeft === currentSession.duration * 60"
            >
                <i class="fas fa-forward"></i>
                Skip
            </button>
        </div>

        <!-- Quick Access Buttons -->
        <div class="flex justify-center gap-3 mb-8">
            <button @click="openStats()" class="btn btn-outline btn-sm gap-2">
                <i class="fas fa-chart-bar"></i>
                Statistics
            </button>
            <button @click="showSettings = !showSettings" class="btn btn-outline btn-sm gap-2">
                <i class="fas fa-cog"></i>
                Settings
            </button>
        </div>

        <!-- Session Progress -->
        <div class="bg-white/80 backdrop-blur-sm rounded-xl p-6 mb-8 shadow-lg">
            <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                <i class="fas fa-tasks text-primary"></i>
                Session Progress
            </h3>
            
            <!-- Progress Dots -->
            <div class="flex justify-center gap-2 mb-4">
                <template x-for="(session, index) in sessionPlan" :key="index">
                    <div 
                        class="w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold transition-all"
                        :class="{
                            'bg-purple-500 text-white': session.type === 'work' && index < currentSessionNumber - 1,
                            'bg-green-500 text-white': session.type === 'break' && index < currentSessionNumber - 1,
                            'bg-yellow-500 text-white animate-pulse': index === currentSessionNumber - 1,
                            'bg-gray-200 text-gray-500': index >= currentSessionNumber
                        }"
                    >
                        <i :class="session.type === 'work' ? 'fas fa-briefcase' : 'fas fa-coffee'"></i>
                    </div>
                </template>
            </div>
            
            <!-- Today's Stats -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                <div class="bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-lg p-3">
                    <div class="text-2xl font-bold" x-text="todayStats.completedPomodoros"></div>
                    <div class="text-sm opacity-90">Pomodoros</div>
                </div>
                <div class="bg-gradient-to-r from-green-500 to-green-600 text-white rounded-lg p-3">
                    <div class="text-2xl font-bold" x-text="Math.floor(todayStats.totalFocusTime / 60)"></div>
                    <div class="text-sm opacity-90">Focus Hours</div>
                </div>
                <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg p-3">
                    <div class="text-2xl font-bold" x-text="todayStats.totalBreakTime"></div>
                    <div class="text-sm opacity-90">Break Minutes</div>
                </div>
                <div class="bg-gradient-to-r from-orange-500 to-orange-600 text-white rounded-lg p-3">
                    <div class="text-2xl font-bold" x-text="currentStreak"></div>
                    <div class="text-sm opacity-90">Day Streak</div>
                </div>
            </div>
        </div>

        <!-- Current Task -->
        <div class="bg-white/80 backdrop-blur-sm rounded-xl p-6 mb-8 shadow-lg">
            <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                <i class="fas fa-clipboard-list text-primary"></i>
                Current Task
            </h3>
            
            <div class="flex gap-4">
                <input 
                    type="text" 
                    x-model="currentTask"
                    placeholder="What are you working on?"
                    class="input input-bordered flex-1"
                    @keyup.enter="addTask()"
                >
                <button @click="addTask()" class="btn btn-primary">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
            
            <!-- Task List -->
            <div class="mt-4 space-y-2" x-show="tasks.length > 0">
                <template x-for="(task, index) in tasks" :key="index">
                    <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                        <input 
                            type="checkbox" 
                            :checked="task.completed"
                            @change="toggleTask(index)"
                            class="checkbox checkbox-primary"
                        >
                        <span 
                            :class="task.completed ? 'line-through text-gray-500' : ''"
                            class="flex-1"
                            x-text="task.text"
                        ></span>
                        <div class="text-sm text-gray-500">
                            <span x-text="task.pomodoros"></span> 🍅
                        </div>
                        <button @click="removeTask(index)" class="btn btn-ghost btn-xs text-red-500">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </template>
            </div>
        </div>
    </main>

    <!-- Settings Modal -->
    <div x-show="showSettings" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
         @click.self="showSettings = false">
        
        <div class="bg-white rounded-xl max-w-md w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold">Settings</h2>
                    <button @click="showSettings = false" class="btn btn-ghost btn-sm">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <!-- Timer Settings -->
                <div class="space-y-6">
                    <div>
                        <label class="label">
                            <span class="label-text font-medium">Work Duration (minutes)</span>
                        </label>
                        <input 
                            type="range" 
                            min="15" 
                            max="60" 
                            step="5"
                            x-model="settings.workDuration"
                            class="range range-primary"
                        >
                        <div class="w-full flex justify-between text-xs px-2">
                            <span>15</span>
                            <span>25</span>
                            <span>45</span>
                            <span>60</span>
                        </div>
                        <div class="text-center text-sm text-gray-600 mt-1">
                            <span x-text="settings.workDuration"></span> minutes
                        </div>
                    </div>
                    
                    <div>
                        <label class="label">
                            <span class="label-text font-medium">Short Break (minutes)</span>
                        </label>
                        <input 
                            type="range" 
                            min="3" 
                            max="15" 
                            step="1"
                            x-model="settings.shortBreak"
                            class="range range-success"
                        >
                        <div class="w-full flex justify-between text-xs px-2">
                            <span>3</span>
                            <span>5</span>
                            <span>10</span>
                            <span>15</span>
                        </div>
                        <div class="text-center text-sm text-gray-600 mt-1">
                            <span x-text="settings.shortBreak"></span> minutes
                        </div>
                    </div>
                    
                    <div>
                        <label class="label">
                            <span class="label-text font-medium">Long Break (minutes)</span>
                        </label>
                        <input 
                            type="range" 
                            min="15" 
                            max="45" 
                            step="5"
                            x-model="settings.longBreak"
                            class="range range-success"
                        >
                        <div class="w-full flex justify-between text-xs px-2">
                            <span>15</span>
                            <span>25</span>
                            <span>35</span>
                            <span>45</span>
                        </div>
                        <div class="text-center text-sm text-gray-600 mt-1">
                            <span x-text="settings.longBreak"></span> minutes
                        </div>
                    </div>
                    
                    <div>
                        <label class="label">
                            <span class="label-text font-medium">Pomodoros before Long Break</span>
                        </label>
                        <select x-model="settings.longBreakInterval" class="select select-bordered w-full">
                            <option value="2">2 Pomodoros</option>
                            <option value="3">3 Pomodoros</option>
                            <option value="4">4 Pomodoros</option>
                            <option value="5">5 Pomodoros</option>
                        </select>
                    </div>
                    
                    <!-- Notification Settings -->
                    <div class="divider">Notifications</div>
                    
                    <div class="form-control">
                        <label class="label cursor-pointer">
                            <span class="label-text">Browser Notifications</span>
                            <input 
                                type="checkbox" 
                                x-model="settings.notifications"
                                @change="requestNotificationPermission()"
                                class="toggle toggle-primary"
                            >
                        </label>
                    </div>
                    
                    <div class="form-control">
                        <label class="label cursor-pointer">
                            <span class="label-text">Sound Alerts</span>
                            <input 
                                type="checkbox" 
                                x-model="settings.soundEnabled"
                                class="toggle toggle-primary"
                            >
                        </label>
                    </div>
                    
                    <div class="form-control">
                        <label class="label cursor-pointer">
                            <span class="label-text">Auto-start Next Session</span>
                            <input 
                                type="checkbox" 
                                x-model="settings.autoStartNext"
                                class="toggle toggle-primary"
                            >
                        </label>
                    </div>
                    
                    <!-- Theme Settings -->
                    <div class="divider">Appearance</div>
                    
                    <div>
                        <label class="label">
                            <span class="label-text font-medium">Theme</span>
                        </label>
                        <select x-model="settings.theme" @change="applyTheme()" class="select select-bordered w-full">
                            <option value="light">Light</option>
                            <option value="dark">Dark</option>
                            <option value="auto">Auto</option>
                        </select>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="flex gap-4 mt-8">
                    <button @click="saveSettings()" class="btn btn-primary flex-1">
                        <i class="fas fa-save"></i>
                        Save Settings
                    </button>
                    <button @click="resetSettings()" class="btn btn-outline">
                        <i class="fas fa-undo"></i>
                        Reset
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Modal -->
    <div x-show="showStats" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
         @click.self="closeStats()"
         x-init="$watch('showStats', value => { if (value) setTimeout(() => initializeChart(), 100); })"
    >
        
        <div class="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold">Statistics</h2>
                    <button @click="closeStats()" class="btn btn-ghost btn-sm">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <!-- Stats Overview -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                    <div class="stat bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-lg">
                        <div class="stat-title text-purple-100">Total Pomodoros</div>
                        <div class="stat-value text-white" x-text="allTimeStats.totalPomodoros"></div>
                    </div>
                    <div class="stat bg-gradient-to-r from-green-500 to-green-600 text-white rounded-lg">
                        <div class="stat-title text-green-100">Focus Hours</div>
                        <div class="stat-value text-white" x-text="Math.floor(allTimeStats.totalFocusTime / 60)"></div>
                    </div>
                    <div class="stat bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg">
                        <div class="stat-title text-blue-100">Current Streak</div>
                        <div class="stat-value text-white" x-text="currentStreak"></div>
                    </div>
                    <div class="stat bg-gradient-to-r from-orange-500 to-orange-600 text-white rounded-lg">
                        <div class="stat-title text-orange-100">Best Streak</div>
                        <div class="stat-value text-white" x-text="allTimeStats.bestStreak"></div>
                    </div>
                </div>
                
                <!-- Weekly Chart -->
                <div class="bg-gray-50 rounded-lg p-4 mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold">Weekly Progress</h3>
                        <div class="flex gap-2">
                            <button @click="addDemoSession()" class="btn btn-xs btn-outline">
                                <i class="fas fa-plus"></i>
                                Demo
                            </button>
                            <button @click="updateChart()" class="btn btn-xs btn-ghost">
                                <i class="fas fa-refresh"></i>
                                Refresh
                            </button>
                        </div>
                    </div>
                    <canvas id="weeklyChart" width="400" height="200" x-ref="weeklyChart"></canvas>
                </div>
                
                <!-- Recent Sessions -->
                <div class="bg-gray-50 rounded-lg p-4">
                    <h3 class="text-lg font-semibold mb-4">Recent Sessions</h3>
                    <div class="space-y-2 max-h-60 overflow-y-auto">
                        <template x-for="session in recentSessions.slice(0, 10)" :key="session.date">
                            <div class="flex items-center justify-between p-3 bg-white rounded-lg">
                                <div class="flex items-center gap-3">
                                    <i :class="session.type === 'work' ? 'fas fa-briefcase text-purple-500' : 'fas fa-coffee text-green-500'"></i>
                                    <span x-text="session.task || 'Untitled Task'"></span>
                                </div>
                                <div class="text-sm text-gray-500">
                                    <span x-text="formatDate(session.date)"></span>
                                    <span class="ml-2" x-text="Math.floor(session.duration / 60) + 'm'"></span>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div 
        x-show="showToast" 
        x-transition:enter="transition ease-out duration-300 transform"
        x-transition:enter-start="opacity-0 translate-x-full"
        x-transition:enter-end="opacity-100 translate-x-0"
        x-transition:leave="transition ease-in duration-200 transform"
        x-transition:leave-start="opacity-100 translate-x-0"
        x-transition:leave-end="opacity-0 translate-x-full"
        class="fixed top-4 right-4 z-50 max-w-sm"
    >
        <div class="toast-notification bg-white border-l-4 border-primary shadow-lg rounded-lg p-4">
            <div class="flex items-center">
                <i class="fas fa-info-circle text-primary mr-3"></i>
                <p x-text="toastMessage" class="text-gray-800"></p>
            </div>
        </div>
    </div>

    <!-- Completion Celebration -->
    <div 
        x-show="showCelebration" 
        x-transition:enter="transition ease-out duration-500"
        x-transition:enter-start="opacity-0 scale-95"
        x-transition:enter-end="opacity-100 scale-100"
        x-transition:leave="transition ease-in duration-200"
        x-transition:leave-start="opacity-100 scale-100"
        x-transition:leave-end="opacity-0 scale-95"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
        @click.self="showCelebration = false"
    >
        <div class="bg-white rounded-xl p-8 text-center max-w-md mx-4">
            <div class="text-6xl mb-4 bounce-subtle">🎉</div>
            <h3 class="text-2xl font-bold mb-2" x-text="celebrationMessage"></h3>
            <p class="text-gray-600 mb-6">Great job staying focused!</p>
            <button @click="showCelebration = false" class="btn btn-primary">
                Continue
            </button>
        </div>
    </div>

    <!-- Audio elements -->
    <audio id="timerCompleteSound" preload="auto">
        <source src="data:audio/wav;base64,UklGRvIGAABXQVZFZm10IBAAAAABAA...">
    </audio>

    <script>
        function pomodoroApp() {
            return {
                // Timer state
                isRunning: false,
                timeLeft: 25 * 60, // 25 minutes in seconds
                timerInterval: null,
                
                // Session management
                currentSessionNumber: 1,
                totalSessions: 8,
                
                // Settings
                settings: {
                    workDuration: 25,
                    shortBreak: 5,
                    longBreak: 15,
                    longBreakInterval: 4,
                    notifications: false,
                    soundEnabled: true,
                    autoStartNext: false,
                    theme: 'light'
                },
                
                // Current session info
                currentSession: {
                    type: 'work',
                    duration: 25,
                    label: 'Focus Time'
                },
                
                // Task management
                currentTask: '',
                tasks: [],
                
                // Statistics
                todayStats: {
                    completedPomodoros: 0,
                    totalFocusTime: 0,
                    totalBreakTime: 0,
                    date: new Date().toDateString()
                },
                
                allTimeStats: {
                    totalPomodoros: 0,
                    totalFocusTime: 0,
                    bestStreak: 0
                },
                
                currentStreak: 0,
                recentSessions: [],
                
                // UI state
                showSettings: false,
                showStats: false,
                showToast: false,
                showCelebration: false,
                toastMessage: '',
                celebrationMessage: '',
                weeklyChart: null,
                
                // Computed properties
                get progress() {
                    const totalTime = this.currentSession.duration * 60;
                    return ((totalTime - this.timeLeft) / totalTime) * 100;
                },
                
                get sessionPlan() {
                    const plan = [];
                    for (let i = 1; i <= this.totalSessions; i++) {
                        if (i % (this.settings.longBreakInterval + 1) === 0 && i < this.totalSessions) {
                            plan.push({ type: 'work', duration: this.settings.workDuration });
                            plan.push({ type: 'break', duration: this.settings.longBreak });
                        } else if (i < this.totalSessions) {
                            plan.push({ type: 'work', duration: this.settings.workDuration });
                            if (i % 2 === 1) {
                                plan.push({ type: 'break', duration: this.settings.shortBreak });
                            }
                        } else {
                            plan.push({ type: 'work', duration: this.settings.workDuration });
                        }
                    }
                    return plan.slice(0, this.totalSessions);
                },
                
                // Initialize the app
                init() {
                    this.loadSettings();
                    this.loadStats();
                    this.loadTasks();
                    this.setupBeforeUnload();
                    this.setupThemeListener();
                    
                    // Update session plan based on settings
                    this.updateCurrentSession();
                    
                    // Check if it's a new day
                    this.checkNewDay();
                    
                    // Watch for changes in recent sessions to update chart
                    this.$watch('recentSessions', () => {
                        if (this.showStats && this.weeklyChart) {
                            this.updateChart();
                        }
                    });
                },
                
                // Timer methods
                toggleTimer() {
                    if (this.isRunning) {
                        this.pauseTimer();
                    } else {
                        this.startTimer();
                    }
                },
                
                startTimer() {
                    this.isRunning = true;
                    this.timerInterval = setInterval(() => {
                        this.timeLeft--;
                        
                        if (this.timeLeft <= 0) {
                            this.completeSession();
                        }
                        
                        // Update title with remaining time
                        document.title = `${this.formatTime(this.timeLeft)} - ${this.currentSession.label}`;
                    }, 1000);
                    
                    this.showToastMessage('Timer started! Stay focused! 🎯');
                },
                
                pauseTimer() {
                    this.isRunning = false;
                    clearInterval(this.timerInterval);
                    document.title = 'Pomodoro Timer - Vibe Coding';
                    this.showToastMessage('Timer paused. Take a moment to breathe 😌');
                },
                
                resetTimer() {
                    this.pauseTimer();
                    this.timeLeft = this.currentSession.duration * 60;
                    document.title = 'Pomodoro Timer - Vibe Coding';
                    this.showToastMessage('Timer reset! Ready for a fresh start 🔄');
                },
                
                skipSession() {
                    this.pauseTimer();
                    this.completeSession();
                },
                
                completeSession() {
                    this.pauseTimer();
                    
                    // Record session
                    this.recordSession();
                    
                    // Play completion sound
                    if (this.settings.soundEnabled) {
                        this.playCompletionSound();
                    }
                    
                    // Show notification
                    this.showSessionCompleteNotification();
                    
                    // Move to next session
                    this.nextSession();
                },
                
                nextSession() {
                    if (this.currentSessionNumber < this.totalSessions) {
                        this.currentSessionNumber++;
                        this.updateCurrentSession();
                        this.timeLeft = this.currentSession.duration * 60;
                        
                        if (this.settings.autoStartNext) {
                            setTimeout(() => {
                                this.startTimer();
                            }, 2000);
                        }
                    } else {
                        // All sessions complete
                        this.showCelebrationModal('All sessions completed! 🏆');
                        this.resetToFirstSession();
                    }
                },
                
                updateCurrentSession() {
                    const sessionIndex = this.currentSessionNumber - 1;
                    const isBreakSession = sessionIndex % 2 === 1 && sessionIndex < this.totalSessions - 1;
                    
                    if (isBreakSession) {
                        const isLongBreak = Math.floor(sessionIndex / 2) % this.settings.longBreakInterval === this.settings.longBreakInterval - 1;
                        this.currentSession = {
                            type: 'break',
                            duration: isLongBreak ? this.settings.longBreak : this.settings.shortBreak,
                            label: isLongBreak ? 'Long Break' : 'Short Break'
                        };
                    } else {
                        this.currentSession = {
                            type: 'work',
                            duration: this.settings.workDuration,
                            label: 'Focus Time'
                        };
                    }
                    
                    this.timeLeft = this.currentSession.duration * 60;
                },
                
                resetToFirstSession() {
                    this.currentSessionNumber = 1;
                    this.updateCurrentSession();
                },
                
                // Task management
                addTask() {
                    if (this.currentTask.trim()) {
                        this.tasks.push({
                            text: this.currentTask.trim(),
                            completed: false,
                            pomodoros: 0,
                            createdAt: new Date()
                        });
                        this.currentTask = '';
                        this.saveTasks();
                        this.showToastMessage('Task added! Let\'s get productive! ✅');
                    }
                },
                
                toggleTask(index) {
                    this.tasks[index].completed = !this.tasks[index].completed;
                    if (this.tasks[index].completed) {
                        this.showToastMessage('Task completed! Great work! 🎉');
                    }
                    this.saveTasks();
                },
                
                removeTask(index) {
                    this.tasks.splice(index, 1);
                    this.saveTasks();
                    this.showToastMessage('Task removed 🗑️');
                },
                
                // Statistics
                recordSession() {
                    const sessionData = {
                        type: this.currentSession.type,
                        duration: this.currentSession.duration * 60,
                        task: this.currentTask || this.tasks.find(t => !t.completed)?.text || 'Untitled Task',
                        date: new Date(),
                        completed: true
                    };
                    
                    this.recentSessions.unshift(sessionData);
                    
                    if (this.currentSession.type === 'work') {
                        this.todayStats.completedPomodoros++;
                        this.todayStats.totalFocusTime += this.currentSession.duration;
                        this.allTimeStats.totalPomodoros++;
                        this.allTimeStats.totalFocusTime += this.currentSession.duration;
                        
                        // Update task pomodoro count
                        const activeTask = this.tasks.find(t => !t.completed);
                        if (activeTask) {
                            activeTask.pomodoros++;
                        }
                        
                        this.updateStreak();
                    } else {
                        this.todayStats.totalBreakTime += this.currentSession.duration;
                    }
                    
                    this.saveStats();
                    this.saveTasks();
                    
                    // Update chart if stats modal is open
                    if (this.showStats && this.weeklyChart) {
                        this.updateChart();
                    }
                },
                
                updateStreak() {
                    const today = new Date().toDateString();
                    const lastSession = this.recentSessions.find(s => s.type === 'work');
                    
                    if (lastSession && new Date(lastSession.date).toDateString() === today) {
                        this.currentStreak++;
                        if (this.currentStreak > this.allTimeStats.bestStreak) {
                            this.allTimeStats.bestStreak = this.currentStreak;
                        }
                    }
                },
                
                checkNewDay() {
                    const today = new Date().toDateString();
                    if (this.todayStats.date !== today) {
                        this.todayStats = {
                            completedPomodoros: 0,
                            totalFocusTime: 0,
                            totalBreakTime: 0,
                            date: today
                        };
                        this.saveStats();
                    }
                },
                
                // Settings
                saveSettings() {
                    localStorage.setItem('pomodoroSettings', JSON.stringify(this.settings));
                    this.updateCurrentSession();
                    this.applyTheme();
                    this.showToastMessage('Settings saved! 💾');
                    this.showSettings = false;
                },
                
                resetSettings() {
                    this.settings = {
                        workDuration: 25,
                        shortBreak: 5,
                        longBreak: 15,
                        longBreakInterval: 4,
                        notifications: false,
                        soundEnabled: true,
                        autoStartNext: false,
                        theme: 'light'
                    };
                    this.saveSettings();
                },
                
                loadSettings() {
                    const saved = localStorage.getItem('pomodoroSettings');
                    if (saved) {
                        this.settings = { ...this.settings, ...JSON.parse(saved) };
                    }
                    this.applyTheme();
                },
                
                // Theme management
                applyTheme() {
                    const html = document.documentElement;
                    
                    // Remove any existing theme classes
                    html.classList.remove('light', 'dark');
                    
                    if (this.settings.theme === 'auto') {
                        // Use system preference
                        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                        html.classList.add(prefersDark ? 'dark' : 'light');
                        html.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
                    } else {
                        // Use selected theme
                        html.classList.add(this.settings.theme);
                        html.setAttribute('data-theme', this.settings.theme);
                    }
                    
                    // Update body background for smooth transition
                    const body = document.body;
                    if (this.settings.theme === 'dark' || 
                        (this.settings.theme === 'auto' && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                        body.className = body.className.replace(
                            'bg-gradient-to-br from-purple-50 via-blue-50 to-indigo-100',
                            'bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900'
                        );
                    } else {
                        body.className = body.className.replace(
                            'bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900',
                            'bg-gradient-to-br from-purple-50 via-blue-50 to-indigo-100'
                        );
                    }
                },
                
                setupThemeListener() {
                    // Listen for system theme changes when in auto mode
                    const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
                    mediaQuery.addListener(() => {
                        if (this.settings.theme === 'auto') {
                            this.applyTheme();
                        }
                    });
                },
                
                // Data persistence
                saveStats() {
                    localStorage.setItem('pomodoroTodayStats', JSON.stringify(this.todayStats));
                    localStorage.setItem('pomodoroAllTimeStats', JSON.stringify(this.allTimeStats));
                    localStorage.setItem('pomodoroCurrentStreak', this.currentStreak.toString());
                    localStorage.setItem('pomodoroRecentSessions', JSON.stringify(this.recentSessions.slice(0, 50)));
                },
                
                loadStats() {
                    const todayStats = localStorage.getItem('pomodoroTodayStats');
                    const allTimeStats = localStorage.getItem('pomodoroAllTimeStats');
                    const streak = localStorage.getItem('pomodoroCurrentStreak');
                    const recent = localStorage.getItem('pomodoroRecentSessions');
                    
                    if (todayStats) this.todayStats = JSON.parse(todayStats);
                    if (allTimeStats) this.allTimeStats = JSON.parse(allTimeStats);
                    if (streak) this.currentStreak = parseInt(streak);
                    if (recent) this.recentSessions = JSON.parse(recent);
                },
                
                saveTasks() {
                    localStorage.setItem('pomodoroTasks', JSON.stringify(this.tasks));
                },
                
                loadTasks() {
                    const saved = localStorage.getItem('pomodoroTasks');
                    if (saved) {
                        this.tasks = JSON.parse(saved);
                    }
                },
                
                // Notifications
                requestNotificationPermission() {
                    if ('Notification' in window && this.settings.notifications && Notification.permission === 'default') {
                        Notification.requestPermission().then(permission => {
                            if (permission === 'granted') {
                                this.showToastMessage('Notifications enabled! You\'ll get alerts when sessions complete 🔔');
                            } else if (permission === 'denied') {
                                this.settings.notifications = false;
                                this.showToastMessage('Notifications blocked. You can enable them in browser settings 🚫');
                            }
                        });
                    }
                },
                
                showSessionCompleteNotification() {
                    const message = this.currentSession.type === 'work' 
                        ? '🎯 Work session completed! Time for a break!'
                        : '☕ Break time is over! Ready to focus?';
                    
                    this.showToastMessage(message);
                    
                    if (this.settings.notifications && Notification.permission === 'granted') {
                        new Notification('Pomodoro Timer', {
                            body: message,
                            icon: '/favicon.ico'
                        });
                    }
                },
                
                showCelebrationModal(message) {
                    this.celebrationMessage = message;
                    this.showCelebration = true;
                },
                
                // UI helpers
                showToastMessage(message) {
                    this.toastMessage = message;
                    this.showToast = true;
                    setTimeout(() => {
                        this.showToast = false;
                    }, 3000);
                },
                
                formatTime(seconds) {
                    const mins = Math.floor(seconds / 60);
                    const secs = seconds % 60;
                    return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                },
                
                formatDate(date) {
                    return new Date(date).toLocaleDateString();
                },
                
                playCompletionSound() {
                    // Simple beep using Web Audio API
                    if (typeof window !== 'undefined' && window.AudioContext) {
                        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();
                        
                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);
                        
                        oscillator.frequency.value = 800;
                        oscillator.type = 'sine';
                        
                        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                        
                        oscillator.start(audioContext.currentTime);
                        oscillator.stop(audioContext.currentTime + 0.5);
                    }
                },
                
                setupBeforeUnload() {
                    window.addEventListener('beforeunload', (e) => {
                        if (this.isRunning) {
                            e.preventDefault();
                            e.returnValue = 'Timer is running. Are you sure you want to leave?';
                        }
                    });
                },
                
                // Chart initialization
                initializeChart() {
                    // Wait for the next tick to ensure DOM is ready
                    this.$nextTick(() => {
                        try {
                            const canvas = document.getElementById('weeklyChart');
                            if (!canvas) {
                                console.warn('Canvas element not found');
                                return;
                            }
                            
                            // Destroy existing chart if it exists
                            if (this.weeklyChart) {
                                this.weeklyChart.destroy();
                                this.weeklyChart = null;
                            }
                            
                            const ctx = canvas.getContext('2d');
                            if (!ctx) {
                                console.warn('Could not get canvas context');
                                return;
                            }
                            
                            // Generate weekly data - ensure we always have data
                            const weeklyData = this.generateWeeklyData();
                            console.log('Initializing chart with data:', weeklyData);
                            
                            this.weeklyChart = new Chart(ctx, {
                                type: 'bar',
                                data: {
                                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                                    datasets: [{
                                        label: 'Completed Pomodoros',
                                        data: weeklyData,
                                        backgroundColor: 'rgba(139, 92, 246, 0.8)',
                                        borderColor: 'rgba(139, 92, 246, 1)',
                                        borderWidth: 1,
                                        borderRadius: 4
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    plugins: {
                                        legend: {
                                            display: false
                                        }
                                    },
                                    scales: {
                                        y: {
                                            beginAtZero: true,
                                            suggestedMax: 5,
                                            ticks: {
                                                stepSize: 1,
                                                callback: function(value) {
                                                    return Number.isInteger(value) ? value : '';
                                                }
                                            }
                                        },
                                        x: {
                                            grid: {
                                                display: false
                                            }
                                        }
                                    },
                                    elements: {
                                        bar: {
                                            borderRadius: 4
                                        }
                                    }
                                }
                            });
                            
                            console.log('Chart initialized successfully with data:', this.weeklyChart.data.datasets[0].data);
                        } catch (error) {
                            console.error('Error initializing chart:', error);
                        }
                    });
                },
                
                generateWeeklyData() {
                    // Generate weekly data based on recent sessions
                    const today = new Date();
                    const weekData = [0, 0, 0, 0, 0, 0, 0];
                    
                    // Process actual session data
                    this.recentSessions.forEach(session => {
                        if (session.type === 'work') {
                            const sessionDate = new Date(session.date);
                            const daysDiff = Math.floor((today - sessionDate) / (1000 * 60 * 60 * 24));
                            if (daysDiff < 7 && daysDiff >= 0) {
                                const dayOfWeek = sessionDate.getDay();
                                const adjustedDay = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // Convert Sunday=0 to Sunday=6
                                weekData[adjustedDay]++;
                            }
                        }
                    });
                    
                    // Always show at least today's progress
                    const currentDay = new Date().getDay();
                    const adjustedCurrentDay = currentDay === 0 ? 6 : currentDay - 1;
                    weekData[adjustedCurrentDay] = Math.max(weekData[adjustedCurrentDay], this.todayStats.completedPomodoros);
                    
                    // Add some demo data if everything is still zero
                    if (weekData.every(val => val === 0)) {
                        // Show a realistic weekly pattern
                        weekData[0] = 2; // Monday
                        weekData[1] = 3; // Tuesday  
                        weekData[2] = 1; // Wednesday
                        weekData[3] = 4; // Thursday
                        weekData[4] = 2; // Friday
                        weekData[5] = 1; // Saturday
                        weekData[6] = 0; // Sunday
                    }
                    
                    console.log('Generated weekly data:', weekData);
                    return weekData;
                },
                
                updateChart() {
                    try {
                        if (this.weeklyChart && this.weeklyChart.data && this.weeklyChart.data.datasets) {
                            const newData = this.generateWeeklyData();
                            console.log('Updating chart with data:', newData);
                            
                            // Update the data
                            this.weeklyChart.data.datasets[0].data = newData;
                            
                            // Force a complete update
                            this.weeklyChart.update('active');
                            
                            console.log('Chart updated successfully');
                        } else {
                            console.warn('Chart not properly initialized, reinitializing...');
                            this.initializeChart();
                        }
                    } catch (error) {
                        console.error('Error updating chart:', error);
                        // Try to reinitialize if update fails
                        try {
                            this.initializeChart();
                        } catch (reinitError) {
                            console.error('Failed to reinitialize chart:', reinitError);
                        }
                    }
                },
                
                closeStats() {
                    // Destroy chart before closing modal
                    try {
                        if (this.weeklyChart) {
                            this.weeklyChart.destroy();
                            this.weeklyChart = null;
                            console.log('Chart destroyed successfully');
                        }
                    } catch (error) {
                        console.error('Error destroying chart:', error);
                        this.weeklyChart = null; // Reset anyway
                    }
                    this.showStats = false;
                },
                
                openStats() {
                    this.showStats = true;
                    // Force chart initialization after a longer delay to ensure DOM is ready
                    setTimeout(() => {
                        if (!this.weeklyChart) {
                            console.log('Initializing chart for first time');
                            this.initializeChart();
                        } else {
                            console.log('Updating existing chart');
                            this.updateChart();
                        }
                    }, 200);
                },
                
                addDemoSession() {
                    // Add a demo work session for today
                    const demoSession = {
                        type: 'work',
                        duration: 1500, // 25 minutes in seconds
                        task: 'Demo Task',
                        date: new Date(),
                        completed: true
                    };
                    
                    this.recentSessions.unshift(demoSession);
                    this.todayStats.completedPomodoros++;
                    this.todayStats.totalFocusTime += 25;
                    this.allTimeStats.totalPomodoros++;
                    this.allTimeStats.totalFocusTime += 25;
                    
                    this.saveStats();
                    
                    // Update chart immediately
                    if (this.weeklyChart) {
                        this.updateChart();
                    }
                    
                    this.showToastMessage('Demo session added! 🎯');
                }
            }
        }
        
        // Initialize app when Alpine.js is ready
        document.addEventListener('alpine:initialized', () => {
            console.log('Pomodoro Timer initialized');
        });
    </script>
</body>
</html>
