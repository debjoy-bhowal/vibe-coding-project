<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Filter Studio - Vibe Tools</title>
    
    <!-- Tailwind CSS & DaisyUI -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.7.2/dist/full.min.css" rel="stylesheet" />
    
    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .card-gradient {
            background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(255,255,255,0.9) 100%);
            backdrop-filter: blur(10px);
        }
        
        .image-container {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 2px dashed #e2e8f0;
            border-radius: 12px;
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: all 0.3s ease;
        }
        
        .image-container.has-image {
            border-style: solid;
            border-color: #667eea;
            background: white;
        }
        
        .image-container:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }
        
        .filter-preview {
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .filter-preview:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .filter-preview.active {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .slider-container {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .download-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
        }
        
        .download-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .reset-btn {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            transition: all 0.3s ease;
        }
        
        .reset-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }
        
        .toast-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }
        
        .toast-notification.show {
            transform: translateX(0);
        }
        
        .toast-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .toast-error {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        
        .feature-card {
            transition: all 0.3s ease;
        }
        
        .feature-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        
        .drag-over {
            border-color: #667eea !important;
            background: rgba(102, 126, 234, 0.1) !important;
        }
        
        .processing {
            opacity: 0.7;
            pointer-events: none;
        }
        
        .canvas-container {
            max-width: 100%;
            overflow: hidden;
            border-radius: 8px;
        }
        
        #imageCanvas {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 0.75rem;
        }
        
        .preset-filter {
            padding: 0.75rem;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.875rem;
        }
        
        .preset-filter:hover {
            border-color: #667eea;
            transform: translateY(-1px);
        }
        
        .preset-filter.active {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }
        
        .history-item {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .history-item:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
        }
        
        .loading-spinner {
            width: 24px;
            height: 24px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>

<body class="min-h-screen gradient-bg" x-data="imageFilterStudio()">
    
    <!-- Header -->
    <header class="bg-white/80 backdrop-blur-md shadow-lg sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <a href="../../index.html" class="btn btn-ghost btn-sm">
                        <i class="fas fa-arrow-left mr-2"></i>
                        Back to Hub
                    </a>
                    <div class="flex items-center space-x-2">
                        <div class="text-3xl">üì∑</div>
                        <div>
                            <h1 class="text-2xl font-bold text-gray-800">Image Filter Studio</h1>
                            <p class="text-sm text-gray-600">Apply filters and effects to your images</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container mx-auto px-4 py-8">
        <div class="grid grid-cols-1 xl:grid-cols-4 gap-8">
            
            <!-- Image Upload and Display -->
            <div class="xl:col-span-3 space-y-6">
                
                <!-- Image Container -->
                <div class="card-gradient rounded-xl p-6 shadow-xl">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-gray-800">
                            <i class="fas fa-image mr-2 text-purple-600"></i>
                            Image Editor
                        </h3>
                        <div class="flex items-center space-x-2">
                            <div class="badge badge-sm" :class="originalImage ? 'badge-success' : 'badge-warning'">
                                <i :class="originalImage ? 'fas fa-check' : 'fas fa-upload'" class="mr-1"></i>
                                <span x-text="originalImage ? 'Image Loaded' : 'Upload Image'"></span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Upload Area -->
                    <div 
                        class="image-container"
                        :class="{ 'has-image': originalImage, 'processing': processing }"
                        @drop="handleDrop($event)"
                        @dragover.prevent="handleDragOver($event)"
                        @dragleave="handleDragLeave($event)"
                        @click="!originalImage && $refs.fileInput.click()"
                    >
                        <div x-show="!originalImage" class="text-center">
                            <i class="fas fa-cloud-upload-alt text-6xl text-gray-400 mb-4"></i>
                            <h4 class="text-xl font-semibold text-gray-700 mb-2">Upload Your Image</h4>
                            <p class="text-gray-500 mb-4">Drag and drop an image file or click to select</p>
                            <button class="btn btn-primary">
                                <i class="fas fa-upload mr-2"></i>
                                Choose File
                            </button>
                            <p class="text-xs text-gray-400 mt-2">Supports: JPG, PNG, GIF, WebP</p>
                        </div>
                        
                        <div x-show="originalImage" class="canvas-container">
                            <canvas id="imageCanvas" x-ref="canvas"></canvas>
                        </div>
                        
                        <div x-show="processing" class="absolute inset-0 bg-white/80 flex items-center justify-center">
                            <div class="text-center">
                                <div class="loading-spinner mx-auto mb-2"></div>
                                <p class="text-gray-600">Processing image...</p>
                            </div>
                        </div>
                    </div>
                    
                    <input 
                        type="file" 
                        x-ref="fileInput"
                        @change="handleFileSelect($event)"
                        accept="image/*"
                        class="hidden"
                    >
                    
                    <!-- Action Buttons -->
                    <div x-show="originalImage" class="flex flex-wrap gap-3 mt-6" x-transition>
                        <button 
                            class="download-btn text-white px-4 py-2 rounded-lg font-medium flex items-center space-x-2"
                            @click="downloadImage()"
                            :disabled="processing"
                        >
                            <i class="fas fa-download"></i>
                            <span>Download</span>
                        </button>
                        
                        <button 
                            class="reset-btn text-white px-4 py-2 rounded-lg font-medium flex items-center space-x-2"
                            @click="resetImage()"
                            :disabled="processing"
                        >
                            <i class="fas fa-undo"></i>
                            <span>Reset</span>
                        </button>
                        
                        <button 
                            class="btn btn-outline px-4 py-2 rounded-lg font-medium flex items-center space-x-2"
                            @click="$refs.fileInput.click()"
                            :disabled="processing"
                        >
                            <i class="fas fa-exchange-alt"></i>
                            <span>Change Image</span>
                        </button>
                    </div>
                </div>

                <!-- Filter Controls -->
                <div x-show="originalImage" class="card-gradient rounded-xl p-6 shadow-xl" x-transition>
                    <h3 class="text-xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-sliders-h mr-2 text-purple-600"></i>
                        Manual Adjustments
                    </h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Brightness -->
                        <div class="slider-container">
                            <label for="brightness-slider" class="block text-sm font-medium text-gray-700 mb-2">
                                Brightness: <span x-text="brightness + '%'"></span>
                            </label>
                            <input 
                                id="brightness-slider"
                                type="range" 
                                min="-100" 
                                max="100" 
                                class="range range-primary w-full"
                                x-model.number="brightness"
                                @input="debounceApplyFilters()"
                            >
                        </div>
                        
                        <!-- Contrast -->
                        <div class="slider-container">
                            <label for="contrast-slider" class="block text-sm font-medium text-gray-700 mb-2">
                                Contrast: <span x-text="contrast + '%'"></span>
                            </label>
                            <input 
                                id="contrast-slider"
                                type="range" 
                                min="-100" 
                                max="100" 
                                class="range range-primary w-full"
                                x-model.number="contrast"
                                @input="debounceApplyFilters()"
                            >
                        </div>
                        
                        <!-- Saturation -->
                        <div class="slider-container">
                            <label for="saturation-slider" class="block text-sm font-medium text-gray-700 mb-2">
                                Saturation: <span x-text="saturation + '%'"></span>
                            </label>
                            <input 
                                id="saturation-slider"
                                type="range" 
                                min="-100" 
                                max="100" 
                                class="range range-primary w-full"
                                x-model.number="saturation"
                                @input="debounceApplyFilters()"
                            >
                        </div>
                        
                        <!-- Hue -->
                        <div class="slider-container">
                            <label for="hue-slider" class="block text-sm font-medium text-gray-700 mb-2">
                                Hue: <span x-text="hue + '¬∞'"></span>
                            </label>
                            <input 
                                id="hue-slider"
                                type="range" 
                                min="-180" 
                                max="180" 
                                class="range range-primary w-full"
                                x-model.number="hue"
                                @input="debounceApplyFilters()"
                            >
                        </div>
                        
                        <!-- Blur -->
                        <div class="slider-container">
                            <label for="blur-slider" class="block text-sm font-medium text-gray-700 mb-2">
                                Blur: <span x-text="blur + 'px'"></span>
                            </label>
                            <input 
                                id="blur-slider"
                                type="range" 
                                min="0" 
                                max="20" 
                                class="range range-primary w-full"
                                x-model.number="blur"
                                @input="debounceApplyFilters()"
                            >
                        </div>
                        
                        <!-- Sepia -->
                        <div class="slider-container">
                            <label for="sepia-slider" class="block text-sm font-medium text-gray-700 mb-2">
                                Sepia: <span x-text="sepia + '%'"></span>
                            </label>
                            <input 
                                id="sepia-slider"
                                type="range" 
                                min="0" 
                                max="100" 
                                class="range range-primary w-full"
                                x-model.number="sepia"
                                @input="debounceApplyFilters()"
                            >
                        </div>
                    </div>
                    
                    <div class="flex gap-3 mt-6">
                        <button 
                            class="btn btn-outline flex items-center space-x-2"
                            @click="resetFilters()"
                            :disabled="processing"
                        >
                            <i class="fas fa-undo"></i>
                            <span>Reset Filters</span>
                        </button>
                        
                        <button 
                            class="btn btn-primary flex items-center space-x-2"
                            @click="saveToHistory()"
                            :disabled="processing"
                        >
                            <i class="fas fa-save"></i>
                            <span>Save State</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Right Panel - Presets and History -->
            <div class="space-y-6">
                
                <!-- Preset Filters -->
                <div class="card-gradient rounded-xl p-6 shadow-xl">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-magic mr-2 text-purple-600"></i>
                        Filter Presets
                    </h3>
                    
                    <div class="filter-grid">
                        <template x-for="preset in filterPresets" :key="preset.name">
                            <div 
                                class="preset-filter"
                                :class="{ 'active': currentPreset === preset.name }"
                                @click="applyPreset(preset)"
                            >
                                <div class="text-2xl mb-1" x-text="preset.icon"></div>
                                <div class="text-xs font-medium" x-text="preset.name"></div>
                            </div>
                        </template>
                    </div>
                </div>
                
                <!-- Image Info -->
                <div x-show="originalImage" class="card-gradient rounded-xl p-6 shadow-xl" x-transition>
                    <h3 class="text-xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-info-circle mr-2 text-purple-600"></i>
                        Image Info
                    </h3>
                    
                    <div class="space-y-3">
                        <div class="flex justify-between items-center py-2 border-b border-purple-100">
                            <span class="text-gray-600 font-medium">Dimensions:</span>
                            <span class="text-gray-800 text-sm" x-text="imageInfo.width + ' √ó ' + imageInfo.height"></span>
                        </div>
                        <div class="flex justify-between items-center py-2 border-b border-purple-100">
                            <span class="text-gray-600 font-medium">File Size:</span>
                            <span class="text-gray-800 text-sm" x-text="imageInfo.size"></span>
                        </div>
                        <div class="flex justify-between items-center py-2 border-b border-purple-100">
                            <span class="text-gray-600 font-medium">Format:</span>
                            <span class="text-gray-800 text-sm" x-text="imageInfo.format"></span>
                        </div>
                        <div class="flex justify-between items-center py-2">
                            <span class="text-gray-600 font-medium">Aspect Ratio:</span>
                            <span class="text-gray-800 text-sm" x-text="imageInfo.aspectRatio"></span>
                        </div>
                    </div>
                </div>
                
                <!-- History -->
                <div x-show="history.length > 0" class="card-gradient rounded-xl p-6 shadow-xl" x-transition>
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-gray-800">
                            <i class="fas fa-history mr-2 text-purple-600"></i>
                            Filter History
                        </h3>
                        <button 
                            class="btn btn-sm btn-outline btn-error"
                            @click="clearHistory()"
                        >
                            <i class="fas fa-trash mr-1"></i>
                            Clear
                        </button>
                    </div>
                    
                    <div class="space-y-2 max-h-60 overflow-y-auto">
                        <template x-for="(item, index) in history.slice().reverse()" :key="index">
                            <div class="history-item" @click="loadFromHistory(item)">
                                <div class="text-sm font-medium" x-text="item.name"></div>
                                <div class="text-xs text-gray-500" x-text="item.timestamp"></div>
                            </div>
                        </template>
                    </div>
                </div>
                
                <!-- Tips -->
                <div class="card-gradient rounded-xl p-6 shadow-xl">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-lightbulb mr-2 text-purple-600"></i>
                        Tips
                    </h3>
                    
                    <div class="space-y-3 text-sm text-gray-700">
                        <div class="flex items-start space-x-2">
                            <i class="fas fa-check-circle text-green-500 mt-0.5"></i>
                            <span>Use presets for quick effects</span>
                        </div>
                        <div class="flex items-start space-x-2">
                            <i class="fas fa-check-circle text-green-500 mt-0.5"></i>
                            <span>Combine multiple adjustments for unique looks</span>
                        </div>
                        <div class="flex items-start space-x-2">
                            <i class="fas fa-check-circle text-green-500 mt-0.5"></i>
                            <span>Save states to easily revert changes</span>
                        </div>
                        <div class="flex items-start space-x-2">
                            <i class="fas fa-info-circle text-blue-500 mt-0.5"></i>
                            <span>Drag and drop images for quick upload</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Features Section -->
        <div class="mt-12">
            <h2 class="text-3xl font-bold text-center text-white mb-8">‚ú® Features</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="feature-card bg-white/90 backdrop-blur-sm rounded-xl p-6 text-center shadow-xl">
                    <div class="text-4xl mb-4">üé®</div>
                    <h3 class="text-lg font-bold text-gray-800 mb-2">Multiple Filters</h3>
                    <p class="text-gray-600 text-sm">Apply brightness, contrast, saturation, blur, and more</p>
                </div>
                
                <div class="feature-card bg-white/90 backdrop-blur-sm rounded-xl p-6 text-center shadow-xl">
                    <div class="text-4xl mb-4">‚ö°</div>
                    <h3 class="text-lg font-bold text-gray-800 mb-2">Real-time Preview</h3>
                    <p class="text-gray-600 text-sm">See changes instantly as you adjust settings</p>
                </div>
                
                <div class="feature-card bg-white/90 backdrop-blur-sm rounded-xl p-6 text-center shadow-xl">
                    <div class="text-4xl mb-4">üìÅ</div>
                    <h3 class="text-lg font-bold text-gray-800 mb-2">Easy Upload</h3>
                    <p class="text-gray-600 text-sm">Drag and drop or click to upload your images</p>
                </div>
                
                <div class="feature-card bg-white/90 backdrop-blur-sm rounded-xl p-6 text-center shadow-xl">
                    <div class="text-4xl mb-4">üíæ</div>
                    <h3 class="text-lg font-bold text-gray-800 mb-2">Download Results</h3>
                    <p class="text-gray-600 text-sm">Save your edited images in high quality</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div 
        id="toast" 
        class="toast-notification"
        :class="toastType"
        x-show="showToast"
        x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0 transform translate-x-full"
        x-transition:enter-end="opacity-100 transform translate-x-0"
        x-transition:leave="transition ease-in duration-300"
        x-transition:leave-start="opacity-100 transform translate-x-0"
        x-transition:leave-end="opacity-0 transform translate-x-full"
    >
        <div class="flex items-center space-x-2">
            <i :class="toastType === 'toast-success' ? 'fas fa-check' : 'fas fa-exclamation-triangle'"></i>
            <span x-text="toastMessage"></span>
        </div>
    </div>

    <script src="../../assets/js/utils.js"></script>
    <script>
        function imageFilterStudio() {
            return {
                // Image data
                originalImage: null,
                currentImageData: null,
                canvas: null,
                ctx: null,
                
                // Filter values
                brightness: 0,
                contrast: 0,
                saturation: 0,
                hue: 0,
                blur: 0,
                sepia: 0,
                
                // UI state
                processing: false,
                showToast: false,
                toastMessage: '',
                toastType: 'toast-success',
                currentPreset: null,
                
                // Image info
                imageInfo: {
                    width: 0,
                    height: 0,
                    size: '',
                    format: '',
                    aspectRatio: ''
                },
                
                // History
                history: [],
                
                // Filter presets
                filterPresets: [
                    {
                        name: 'Original',
                        icon: 'üîÑ',
                        filters: { brightness: 0, contrast: 0, saturation: 0, hue: 0, blur: 0, sepia: 0 }
                    },
                    {
                        name: 'Vintage',
                        icon: 'üì∏',
                        filters: { brightness: 10, contrast: 15, saturation: -20, hue: 5, blur: 0, sepia: 30 }
                    },
                    {
                        name: 'B&W',
                        icon: '‚ö´',
                        filters: { brightness: 0, contrast: 20, saturation: -100, hue: 0, blur: 0, sepia: 0 }
                    },
                    {
                        name: 'Sepia',
                        icon: 'üü§',
                        filters: { brightness: 5, contrast: 10, saturation: -30, hue: 20, blur: 0, sepia: 80 }
                    },
                    {
                        name: 'Vibrant',
                        icon: 'üåà',
                        filters: { brightness: 15, contrast: 25, saturation: 40, hue: 0, blur: 0, sepia: 0 }
                    },
                    {
                        name: 'Cool',
                        icon: 'üßä',
                        filters: { brightness: 0, contrast: 10, saturation: 10, hue: -15, blur: 0, sepia: 0 }
                    },
                    {
                        name: 'Warm',
                        icon: 'üî•',
                        filters: { brightness: 10, contrast: 5, saturation: 15, hue: 10, blur: 0, sepia: 10 }
                    },
                    {
                        name: 'Soft',
                        icon: '‚òÅÔ∏è',
                        filters: { brightness: 15, contrast: -10, saturation: -10, hue: 0, blur: 2, sepia: 0 }
                    },
                    {
                        name: 'Sharp',
                        icon: '‚ö°',
                        filters: { brightness: 0, contrast: 40, saturation: 20, hue: 0, blur: 0, sepia: 0 }
                    },
                    {
                        name: 'Dream',
                        icon: '‚ú®',
                        filters: { brightness: 20, contrast: -15, saturation: 30, hue: 5, blur: 1, sepia: 5 }
                    },
                    {
                        name: 'Noir',
                        icon: 'üé≠',
                        filters: { brightness: -20, contrast: 50, saturation: -100, hue: 0, blur: 0, sepia: 0 }
                    },
                    {
                        name: 'Sunset',
                        icon: 'üåÖ',
                        filters: { brightness: 10, contrast: 15, saturation: 25, hue: 15, blur: 0, sepia: 20 }
                    }
                ],
                
                // Debounce timer
                debounceTimer: null,
                
                init() {
                    this.canvas = this.$refs.canvas;
                    this.ctx = this.canvas.getContext('2d');
                    
                    // Load history from localStorage
                    const saved = localStorage.getItem('imageFilterHistory');
                    if (saved) {
                        this.history = JSON.parse(saved);
                    }
                },
                
                handleFileSelect(event) {
                    const file = event.target.files[0];
                    if (file) {
                        this.loadImage(file);
                    }
                },
                
                handleDrop(event) {
                    event.preventDefault();
                    event.target.classList.remove('drag-over');
                    
                    const files = event.dataTransfer.files;
                    if (files.length > 0) {
                        const file = files[0];
                        if (file.type.startsWith('image/')) {
                            this.loadImage(file);
                        } else {
                            this.showToastMessage('Please upload an image file', 'toast-error');
                        }
                    }
                },
                
                handleDragOver(event) {
                    event.preventDefault();
                    event.target.classList.add('drag-over');
                },
                
                handleDragLeave(event) {
                    event.target.classList.remove('drag-over');
                },
                
                async loadImage(file) {
                    try {
                        this.processing = true;
                        
                        // Validate file size (max 10MB)
                        if (file.size > 10 * 1024 * 1024) {
                            this.showToastMessage('File size must be less than 10MB', 'toast-error');
                            this.processing = false;
                            return;
                        }
                        
                        // Validate file type
                        if (!file.type.startsWith('image/')) {
                            this.showToastMessage('Please select a valid image file', 'toast-error');
                            this.processing = false;
                            return;
                        }
                        
                        const img = new Image();
                        img.onload = () => {
                            // Set up canvas
                            const maxWidth = 800;
                            const maxHeight = 600;
                            let { width, height } = img;
                            
                            // Scale down if too large
                            if (width > maxWidth || height > maxHeight) {
                                const ratio = Math.min(maxWidth / width, maxHeight / height);
                                width *= ratio;
                                height *= ratio;
                            }
                            
                            this.canvas.width = width;
                            this.canvas.height = height;
                            
                            // Draw original image
                            this.ctx.drawImage(img, 0, 0, width, height);
                            this.originalImage = this.ctx.getImageData(0, 0, width, height);
                            this.currentImageData = {...this.originalImage};
                            
                            // Set image info
                            this.imageInfo = {
                                width: Math.round(width),
                                height: Math.round(height),
                                size: this.formatFileSize(file.size),
                                format: file.type.split('/')[1].toUpperCase(),
                                aspectRatio: (width / height).toFixed(2)
                            };
                            
                            // Reset filters
                            this.resetFilters();
                            this.processing = false;
                            this.showToastMessage('Image loaded successfully!', 'toast-success');
                        };
                        
                        img.onerror = () => {
                            this.showToastMessage('Failed to load image', 'toast-error');
                            this.processing = false;
                        };
                        
                        img.src = URL.createObjectURL(file);
                        
                    } catch (error) {
                        console.error('Error loading image:', error);
                        this.showToastMessage('Failed to load image', 'toast-error');
                        this.processing = false;
                    }
                },
                
                debounceApplyFilters() {
                    clearTimeout(this.debounceTimer);
                    this.debounceTimer = setTimeout(() => {
                        this.applyFilters();
                    }, 50); // Reduced debounce time for more responsive feel
                },
                
                applyFilters() {
                    if (!this.originalImage) return;
                    
                    this.processing = true;
                    
                    // Use requestAnimationFrame for smooth updates
                    requestAnimationFrame(() => {
                        try {
                            // Clear the canvas
                            this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                            
                            // Reset any existing filters on canvas
                            this.canvas.style.filter = 'none';
                            
                            // Draw the original image first
                            this.ctx.putImageData(this.originalImage, 0, 0);
                            
                            // Apply CSS filters to canvas for preview
                            const filterString = [
                                `brightness(${100 + parseInt(this.brightness)}%)`,
                                `contrast(${100 + parseInt(this.contrast)}%)`,
                                `saturate(${100 + parseInt(this.saturation)}%)`,
                                `hue-rotate(${parseInt(this.hue)}deg)`,
                                `blur(${parseInt(this.blur)}px)`,
                                `sepia(${parseInt(this.sepia)}%)`
                            ].join(' ');
                            
                            this.canvas.style.filter = filterString;
                            
                        } catch (error) {
                            console.error('Error applying filters:', error);
                            // Fallback: restore original image
                            this.ctx.putImageData(this.originalImage, 0, 0);
                            this.canvas.style.filter = 'none';
                        }
                        
                        this.processing = false;
                    });
                },
                
                applyPreset(preset) {
                    if (!this.originalImage) return;
                    
                    this.currentPreset = preset.name;
                    
                    // Apply preset values with proper type conversion
                    this.brightness = parseInt(preset.filters.brightness) || 0;
                    this.contrast = parseInt(preset.filters.contrast) || 0;
                    this.saturation = parseInt(preset.filters.saturation) || 0;
                    this.hue = parseInt(preset.filters.hue) || 0;
                    this.blur = parseInt(preset.filters.blur) || 0;
                    this.sepia = parseInt(preset.filters.sepia) || 0;
                    
                    // Apply the filters
                    this.applyFilters();
                    this.showToastMessage(`Applied ${preset.name} filter`, 'toast-success');
                },
                
                resetFilters() {
                    this.brightness = 0;
                    this.contrast = 0;
                    this.saturation = 0;
                    this.hue = 0;
                    this.blur = 0;
                    this.sepia = 0;
                    this.currentPreset = 'Original';
                    
                    if (this.canvas && this.originalImage) {
                        this.canvas.style.filter = 'none';
                        this.ctx.putImageData(this.originalImage, 0, 0);
                    }
                },
                
                resetImage() {
                    if (!this.originalImage) return;
                    
                    this.resetFilters();
                    this.ctx.putImageData(this.originalImage, 0, 0);
                    this.showToastMessage('Image reset to original', 'toast-success');
                },
                
                saveToHistory() {
                    if (!this.originalImage) return;
                    
                    const state = {
                        name: this.currentPreset || 'Custom',
                        timestamp: new Date().toLocaleString(),
                        filters: {
                            brightness: this.brightness,
                            contrast: this.contrast,
                            saturation: this.saturation,
                            hue: this.hue,
                            blur: this.blur,
                            sepia: this.sepia
                        }
                    };
                    
                    this.history.push(state);
                    
                    // Keep only last 10 states
                    if (this.history.length > 10) {
                        this.history = this.history.slice(-10);
                    }
                    
                    // Save to localStorage
                    localStorage.setItem('imageFilterHistory', JSON.stringify(this.history));
                    this.showToastMessage('State saved to history', 'toast-success');
                },
                
                loadFromHistory(item) {
                    if (!this.originalImage) return;
                    
                    // Apply history values with proper type conversion
                    this.brightness = parseInt(item.filters.brightness) || 0;
                    this.contrast = parseInt(item.filters.contrast) || 0;
                    this.saturation = parseInt(item.filters.saturation) || 0;
                    this.hue = parseInt(item.filters.hue) || 0;
                    this.blur = parseInt(item.filters.blur) || 0;
                    this.sepia = parseInt(item.filters.sepia) || 0;
                    this.currentPreset = item.name;
                    
                    this.applyFilters();
                    this.showToastMessage(`Loaded ${item.name} from history`, 'toast-success');
                },
                
                clearHistory() {
                    this.history = [];
                    localStorage.removeItem('imageFilterHistory');
                    this.showToastMessage('History cleared', 'toast-success');
                },
                
                async downloadImage() {
                    if (!this.originalImage) return;
                    
                    try {
                        this.processing = true;
                        
                        // Create a temporary canvas for final rendering
                        const tempCanvas = document.createElement('canvas');
                        const tempCtx = tempCanvas.getContext('2d');
                        
                        tempCanvas.width = this.canvas.width;
                        tempCanvas.height = this.canvas.height;
                        
                        // Draw the original image
                        tempCtx.putImageData(this.originalImage, 0, 0);
                        
                        // Apply filters using CSS filters (same as preview)
                        const filterString = [
                            `brightness(${100 + this.brightness}%)`,
                            `contrast(${100 + this.contrast}%)`,
                            `saturate(${100 + this.saturation}%)`,
                            `hue-rotate(${this.hue}deg)`,
                            `blur(${this.blur}px)`,
                            `sepia(${this.sepia}%)`
                        ].join(' ');
                        
                        tempCanvas.style.filter = filterString;
                        
                        // Convert to blob and download
                        tempCanvas.toBlob((blob) => {
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = `filtered-image-${Date.now()}.png`;
                            a.click();
                            URL.revokeObjectURL(url);
                            
                            this.processing = false;
                            this.showToastMessage('Image downloaded successfully!', 'toast-success');
                        }, 'image/png');
                        
                    } catch (error) {
                        console.error('Download error:', error);
                        this.showToastMessage('Failed to download image', 'toast-error');
                        this.processing = false;
                    }
                },
                
                formatFileSize(bytes) {
                    if (bytes === 0) return '0 Bytes';
                    const k = 1024;
                    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                },
                
                showToastMessage(message, type = 'toast-success') {
                    this.toastMessage = message;
                    this.toastType = type;
                    this.showToast = true;
                    
                    setTimeout(() => {
                        this.showToast = false;
                    }, 3000);
                }
            }
        }
    </script>
</body>
</html>
